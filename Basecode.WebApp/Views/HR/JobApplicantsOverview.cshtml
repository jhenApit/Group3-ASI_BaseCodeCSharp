@using Basecode.Data.Enums;
@using Basecode.Data.Models
@using static Basecode.Data.Enums.Enums;
@using Basecode.Services.Interfaces
@using System.Drawing;
@inject IJobPostingsService jobPostingService
@model List<Applicants>
@{
	ViewData["Title"] = "Job Applicants Overview";
	Layout = "_SideBarAdmin";
	<meta name="viewport" content="width=device-width" />
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css">
	<link rel="stylesheet" href="~/css/JobApplicantsOverview.css" />
}


<div class="container">
	<h1>@ViewData["Title"]</h1>
</div>
<div class="table-container">
	<div class="select-container">
		<label for="position">Position:</label>
		<select id="position" name="position">
			<option value="ALL">ALL</option>
			<option value="Software Developers">Software Developers</option>
			<option value="HR Staff">HR Staff</option>
		</select>
		<label for="status" style="margin-left: 20px;">Status:</label>
		<select id="status" name="status">
			<option value="ALL">ALL</option>
			<option value="DEPLOYED">DEPLOYED</option>
			<option value="FOR REVIEW">FOR REVIEW</option>
			<option value="FOR SCREENING">FOR SCREENING</option>
			<option value="INVITE TO INTERVIEW">INVITE TO INTERVIEW</option>
			<option value="ONBOARDING">ONBOARDING</option>
			<option value="SHORTLISTED">SHORTLISTED</option>
			<option value="UNDERGOING JOB OFFER">UNDERGOING JOB OFFER</option>
			<option value="REJECTED">REJECTED</option>
		</select>
	</div>
	<div class="table-responsive">
		<table class="table">
			<thead>
				<tr>
					<th style="border-left: 10px solid #55729B; border-bottom: none;">Applicant Name</th>
					<th>Position Name</th>
					<th>Status</th>
					<th></th>
				</tr>
			</thead>
			<tbody>
				<!-- Data rows displayed here -->
				@foreach (var applicant in Model)
				{
					Color statusColor = EnumHelper.GetColorForApplicationStatus(applicant.ApplicationStatus);
					string colorStyle = $"color: {ColorTranslator.ToHtml(statusColor)}";
					var jobPosting = jobPostingService.GetById(applicant.JobId);
					var positionName = jobPosting != null ? jobPosting.Name : "Position Not Found";
					<tr>
						<td>@applicant.Name</td>
						<td>@positionName</td>
						<td style ="@colorStyle">@EnumHelper.GetEnumDescription(((ApplicationStatus)Enum.Parse(typeof(ApplicationStatus), applicant.ApplicationStatus.ToString())))</td>
						<td>
							<div class="applicant-container" data-title="@applicant.ApplicationStatus">
								@switch (applicant.ApplicationStatus)
								{
									case ApplicationStatus.Received:
									<a asp-route-id ="@applicant.Id" class="status-btn" asp-controller="HR" asp-action="ShortListApplicant">SHORTLIST</a>
									<a asp-route-id ="@applicant.Id" class="reject-btn" asp-controller="HR" asp-action="RejectApplicant">REJECT</a>
											break;
									case ApplicationStatus.Shortlisted:
									<a asp-route-id ="@applicant.Id" class="status-btn" asp-controller="HR" asp-action="ForScreeningApplicant">FOR SCREENING</a>
									<a asp-route-id ="@applicant.Id" class="reject-btn" asp-controller="HR" asp-action="RejectApplicant">REJECT</a>
											break;
									case ApplicationStatus.ForScreening:
									<a asp-route-id ="@applicant.Id" class="status-btn" asp-controller="HR" asp-action="InviteToHRInterview">INVITE TO HR INTERVIEW</a>
										<a asp-route-id="@applicant.Id" class="reject-btn" asp-controller="HR" asp-action="RejectApplicant">REJECT</a>
											break;
									case ApplicationStatus.ForHRInterview:
									<a asp-route-id ="@applicant.Id" class="status-btn" asp-controller="HR" asp-action="InviteToTechnicalInterview">INVITE TO TECHNICAL INTERVIEW</a>
										<a asp-route-id="@applicant.Id" class="reject-btn" asp-controller="HR" asp-action="RejectApplicant">REJECT</a>
											break;
									case ApplicationStatus.ForTechnicalInterview:
									<a asp-route-id ="@applicant.Id" class="status-btn" asp-controller="HR" asp-action="InviteToTechnicalExam">INVITE TO TECHNICAL EXAM</a>
										<a asp-route-id="@applicant.Id" class="reject-btn" asp-controller="HR" asp-action="RejectApplicant">REJECT</a>
											break;
									case ApplicationStatus.ForTechnicalExam:
									<a asp-route-id ="@applicant.Id" class="status-btn" asp-controller="HR" asp-action="CheckBackground">CHECK BACKGROUND</a>
										<a asp-route-id="@applicant.Id" class="reject-btn" asp-controller="HR" asp-action="RejectApplicant">REJECT</a>
											break;
									case ApplicationStatus.UndergoingBackgroundCheck:
									<a asp-route-id="@applicant.Id" class="status-btn" asp-controller="HR" asp-action="InviteToFinalInterview">INVITE TO FINAL INTERVIEW</a>
										<a asp-route-id="@applicant.Id" class="reject-btn" asp-controller="HR" asp-action="RejectApplicant">REJECT</a>
											break;
									case ApplicationStatus.ForFinalInterview:
									<a asp-route-id="@applicant.Id" class="status-btn" asp-controller="HR" asp-action="SendJobOffer">SEND JOB OFFER</a>
										<a asp-route-id="@applicant.Id" class="reject-btn" asp-controller="HR" asp-action="RejectApplicant">REJECT</a>
											break;
									case ApplicationStatus.UndergoingJobOffer:
									<a asp-route-id="@applicant.Id" class="status-btn" asp-controller="HR" asp-action="ConfirmApplicant">CONFIRM</a>
									<a asp-route-id="@applicant.Id" class="decline-btn" asp-controller="HR" asp-action="DeclineApplicant">DECLINE</a>
											break;
									case ApplicationStatus.Onboarding:
									<a asp-route-id="@applicant.Id" class="status-btn" asp-controller="HR" asp-action="DeployApplicant" style="justify-content: flex-start !important;">DEPLOY </a>
										break;
									default:
										break;
								}
							</div>
						</td>
					</tr>
				}
			</tbody>
		</table>
	</div>
	<div class="pagination-container">
		<ul class="pagination">
			<!-- Pagination links will be added dynamically via JavaScript -->
		</ul>
	</div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
	// ...  demo-data
	$(document).ready(function () {

		const itemsPerPage = 10; // Number of items to display per page
		let currentPage = 1;
		let filteredApplicants = applicants.slice();

		function redirectToApplicantDetail(applicantIndex) {
			const applicant = applicants[applicantIndex];
			const detailUrl = '/HR/ApplicantDetail?name=' + encodeURIComponent(applicant.Name) + '&position=' + encodeURIComponent(applicant.Position) + '&status=' + encodeURIComponent(applicant.Status);
			window.location.href = detailUrl;
		}

		function handleButtonClicks() {
			// Add click event handler to each row
			$(".table tbody tr").on("click", function () {
				const applicantIndex = $(this).attr("data-applicant-index");
				redirectToApplicantDetail(applicantIndex);
			});

			// Add click event handler for buttons
			$(".table tbody tr .status-btn").on("click", function (event) {
				event.stopPropagation();

				const button = $(this);
				const row = button.closest("tr");
				const applicantIndex = row.attr("data-applicant-index");
				const applicant = applicants[applicantIndex];

				const buttonText = button.text().trim();
				switch (buttonText) {
					case "FOR REVIEW":
						alert(`${applicant.Name}'s Application is now FOR REVIEW!`);
						break;
					case "SHORTLIST":
						alert(`${applicant.Name}'s Application has been SHORTLISTED!`);
						break;
					case "FOR SCREENING":
						alert(`${applicant.Name}'s Application is now FOR SCREENING!`);
						break;
					case "INVITE TO INTERVIEW":
						alert(`${applicant.Name} has been INVITED TO INTERVIEW!`);
						break;
					case "UNDERGOING JOB OFFER":
						alert(`${applicant.Name}'s is UNDERGOING JOB OFFER!`);
						break;
					case "ONBOARDING":
						alert(`${applicant.Name}'s Application status is ONBOARDING!`);
						break;
					case "DEPLOY":
						alert(`${applicant.Name} has been DEPLOYED!`);
						break;
					case "SEND JOB OFFER":
						alert(`${applicant.Name} has been SENT A JOB OFFER!`);
						break;
					case "CONFIRM":
						alert(`${applicant.Name}'s JOB OFFER has been CONFIRMED!`);
						break;
					default:
						break;
				}
			});

			// Add click event handler for the "REJECT" button
			$(".table tbody tr .reject-btn").on("click", function (event) {
				event.stopPropagation();
				const button = $(this);
				const row = button.closest("tr");
				const applicantIndex = row.attr("data-applicant-index");
				const applicant = applicants[applicantIndex];
				alert(`${applicant.Name}'s Application has been REJECTED!`);
			});

			// Add click event handler for the "DECLINE" button
			$(".table tbody tr .decline-btn").on("click", function (event) {
				event.stopPropagation();
				const button = $(this);
				const row = button.closest("tr");
				const applicantIndex = row.attr("data-applicant-index");
				const applicant = applicants[applicantIndex];
				alert(`${applicant.Name}'s Application has been DECLINED!`);
			});
		}

		function displayData(currentPage) {
			const startIndex = (currentPage - 1) * itemsPerPage;
			const endIndex = startIndex + itemsPerPage;
			const currentApplicants = filteredApplicants.slice(startIndex, endIndex);

			const tbody = $(".table tbody");
			tbody.empty();
			$.each(currentApplicants, function (index, applicant) {
				const row = $(`<tr>`);
				const applicantIndex = applicants.indexOf(applicant);
				row.attr("data-applicant-index", applicantIndex);
				row.append(`<td title="Click to View Applicant Details">${applicant.Name}</td>`);
				row.append(`<td title="Click to View Applicant Details">${applicant.Position}</td>`);
				row.append(`<td title="Click to View Applicant Details">${applicant.Status}</td>`);
				row.append(`
				  <td>
					<div class="applicant-container" data-title="${applicant.Status}">
					  ${getStatusButtons(applicant.Status)}
					</div>
				  </td>
			`);
				tbody.append(row);
			});

			handleButtonClicks();
		}

		function displayPagination() {
			const totalItems = filteredApplicants.length;
			const totalPages = Math.ceil(totalItems / itemsPerPage);

			const paginationContainer = $(".pagination");
			paginationContainer.empty();

			// Previous button
			const prevBtn = `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}"><a class="page-link" href="#" data-page="${currentPage - 1}">Previous</a></li>`;
			paginationContainer.append(prevBtn);

			for (let i = 1; i <= totalPages; i++) {
				const pageLink = `<li class="page-item ${currentPage === i ? 'active' : ''}"><a class="page-link" href="#" data-page="${i}">${i}</a></li>`;
				paginationContainer.append(pageLink);
			}

			// Next button
			const nextBtn = `<li class="page-item ${currentPage < totalPages ? '' : 'disabled'}"><a class="page-link" href="#" data-page="${currentPage + 1}">Next</a></li>`;
			paginationContainer.append(nextBtn);

			$(".pagination").on("click", ".page-link", function (event) {
				event.preventDefault();
				currentPage = parseInt($(this).data("page"));
				displayData(currentPage);
				displayPagination();
			});
		}

		function applyFilters() {
			const selectedPosition = $("#position").val();
			const selectedStatus = $("#status").val();

			filteredApplicants = applicants.filter(applicant => {
				if (selectedPosition === "ALL" && selectedStatus === "ALL") {
					return true;
				}
				if (selectedPosition === "ALL") {
					return applicant.Status === selectedStatus;
				}
				if (selectedStatus === "ALL") {
					return applicant.Position === selectedPosition;
				}
				return applicant.Position === selectedPosition && applicant.Status === selectedStatus;
			});

			displayData(1);
			displayPagination();
		}

		// Apply filters when the status or position dropdown changes
		$("#status, #position").on("change", function () {
			applyFilters();
		});

		displayData(currentPage);
		displayPagination();
	});

	document.addEventListener("DOMContentLoaded", function () {
		const statusDropdown = document.getElementById('status');
		const titleHeaders = document.querySelectorAll('.title-header');
		const applicantContainers = document.querySelectorAll('.applicant-container');

		// Display filtered data immediately after changing filters
		function applyFilters() {
			displayData(); 
			displayPagination();
		}

		statusDropdown.onchange = function () {
			applyFilters();

			const selectedStatus = statusDropdown.value;
			const selectedHeader = document.querySelector('.title-header[data-title="' + selectedStatus + '"]');
			if (selectedHeader) {
				selectedHeader.style.display = 'flex';
			}

			if (selectedStatus === 'ALL') {
				applicantContainers.forEach(container => {
					container.style.display = 'flex';
				});
			} else {
				applicantContainers.forEach(container => {
					container.style.display = 'none';
				});

				const selectedContainers = document.querySelectorAll('.applicant-container[data-title="' + selectedStatus + '"]');
				selectedContainers.forEach(container => {
					container.style.display = 'flex';
				});
			}
		};
	});
</script>