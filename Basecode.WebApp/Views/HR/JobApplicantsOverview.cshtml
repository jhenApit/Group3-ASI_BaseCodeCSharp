@using Basecode.Data.Enums;
@using Basecode.Data.Models
@using static Basecode.Data.Enums.Enums;
@using Basecode.Services.Interfaces
@inject IJobPostingsService jobPostingService;
@using System.Drawing;
@model JobApplicantOverviewModel
@{
	ViewData["Title"] = "Job Applicants Overview";
	Layout = "_SideBarAdmin";
	<link rel="stylesheet" href="~/css/JobApplicantsOverview.css" />
}

<div class="container container-header">
	<h1>@ViewData["Title"]</h1>
</div>
<div class="container table-container">
	<div class="select-container">
		<label for="position">Position:</label>
		<select id="position" name="position">
			<option value="ALL">ALL</option>
			@foreach (var jobPosting in Model.jobPostings)
			{
				<option value="@jobPosting.Name">@jobPosting.Name</option>
			}
		</select>
		<label for="status" style="margin-left: 20px;">Status:</label>
		<select id="status" name="status">
			<option value="ALL">ALL</option>
			@foreach (ApplicationStatus status in Enum.GetValues(typeof(ApplicationStatus)))
			{
				<option value="@status.ToString()">@EnumHelper.GetEnumDescription(status)</option>
			}
		</select>
	</div>
	<div class="table-responsive">
		<table class="table">
			<thead>
				<tr class="text-center">
					<th scope="col" class="col-2" style="border-left: 10px solid #55729B; border-bottom: none;">Applicant Name</th>
					<th scope="col" class="col-2">Position Name</th>
					<th scope="col" class="col-2">Status</th>
					<th scope="col" class="col-3" style="border-right: 10px solid #55729B; border-bottom: none;">Action</th>
				</tr>
			</thead>
			<tbody>
				@foreach (var applicant in Model.applicants.OrderBy(a => a.Name))
				{
					Color statusColor = EnumHelper.GetColorForApplicationStatus(applicant.ApplicationStatus);
					string colorStyle = $"color: {ColorTranslator.ToHtml(statusColor)}; font-weight: 500;";
					
					// ******** To refactor **************
					var jobPost = jobPostingService.GetById(applicant.JobId);
					var positionName = jobPost?.Name;
					<a asp-route-id="Id" asp-controller="HR" asp-action="ApplicantDetail">
					<tr>
						<td>@applicant.Name</td>
						<td>@positionName</td>
						<td class="text-bold" style ="@colorStyle">@EnumHelper.GetEnumDescription(((ApplicationStatus)Enum.Parse(typeof(ApplicationStatus), applicant.ApplicationStatus.ToString())))</td>
					var positionName = jobPost.Name;
					<tr class="clickable-row" data-href="/HR/ApplicantDetail?applicantId=@applicant.Id">
						<td title="Click to View Applicant Details">@applicant.Name</td>
						<td title="Click to View Applicant Details">@positionName</td>
						<td title="Click to View Applicant Details" style="@colorStyle">@EnumHelper.GetEnumDescription(((ApplicationStatus)Enum.Parse(typeof(ApplicationStatus), applicant.ApplicationStatus.ToString())))</td>
						<td>
							<div class="applicant-container" data-title="@applicant.ApplicationStatus">
								@switch (applicant.ApplicationStatus)
								{
									case ApplicationStatus.Received:
										<form asp-controller="HR" asp-action="UpdateApplicantStatus" method="post">
											<input type="hidden" name="id" value="@applicant.Id" />
											<input type="hidden" name="status" value="Shortlisted" />
											<button type="submit" class="btn status-btn status-change-btn">SHORTLIST</button>
										</form>
										<form asp-controller="HR" asp-action="UpdateApplicantStatus" method="post">
											<input type="hidden" name="id" value="@applicant.Id" />
											<input type="hidden" name="status" value="Rejected" />
											<button type="submit" class="btn reject-btn">REJECT</button>
										</form>
											break;
										<a asp-route-id="@applicant.Id" class="status-btn" asp-controller="HR" asp-action="ShortListApplicant">SHORTLIST</a>
										<a asp-route-id="@applicant.Id" class="reject-btn" asp-controller="HR" asp-action="RejectApplicant">REJECT</a>
										break;
									case ApplicationStatus.Shortlisted:
										<form asp-controller="HR" asp-action="UpdateApplicantStatus" method="post">
											<input type="hidden" name="id" value="@applicant.Id" />
											<input type="hidden" name="status" value="ForScreening" />
											<button type="submit" class="btn status-btn status-change-btn">FOR SCREENING</button>
										</form>
										<form asp-controller="HR" asp-action="UpdateApplicantStatus" method="post">
											<input type="hidden" name="id" value="@applicant.Id" />
											<input type="hidden" name="status" value="Rejected" />
											<button type="submit" class="btn reject-btn">REJECT</button>
										</form>
											break;
										<a asp-route-id="@applicant.Id" class="status-btn" asp-controller="HR" asp-action="ForScreeningApplicant">FOR SCREENING</a>
										<a asp-route-id="@applicant.Id" class="reject-btn" asp-controller="HR" asp-action="RejectApplicant">REJECT</a>
										break;
									case ApplicationStatus.ForScreening:
										<form asp-controller="HR" asp-action="UpdateApplicantStatus" method="post">
											<input type="hidden" name="id" value="@applicant.Id" />
											<input type="hidden" name="status" value="ForHRInterview" />
											<button type="submit" class="btn status-btn status-change-btn">INVITE TO HR INTERVIEW</button>
											</form>
										<form asp-controller="HR" asp-action="UpdateApplicantStatus" method="post">
											<input type="hidden" name="id" value="@applicant.Id" />
											<input type="hidden" name="status" value="Rejected" />
											<button type="submit" class="btn reject-btn">REJECT</button>
										</form>
											break;
										case ApplicationStatus.ForHRInterview:
										<form asp-controller="HR" asp-action="UpdateApplicantStatus" method="post">
											<input type="hidden" name="id" value="@applicant.Id" />
											<input type="hidden" name="status" value="ForTechnicalInterview" />
											<button type="submit" class="btn status-btn status-change-btn">INVITE TO TECHNICAL INTERVIEW</button>
											</form>
										<form asp-controller="HR" asp-action="UpdateApplicantStatus" method="post">
											<input type="hidden" name="id" value="@applicant.Id" />
											<input type="hidden" name="status" value="Rejected" />
											<button type="submit" class="btn reject-btn">REJECT</button>
										</form>
											break;
										case ApplicationStatus.ForTechnicalInterview:
										<form asp-controller="HR" asp-action="UpdateApplicantStatus" method="post">
											<input type="hidden" name="id" value="@applicant.Id" />
											<input type="hidden" name="status" value="ForTechnicalExam" />
											<button type="submit" class="btn status-btn status-change-btn">INVITE TO TECHNICAL EXAM</button>
										</form>
										<form asp-controller="HR" asp-action="UpdateApplicantStatus" method="post">
											<input type="hidden" name="id" value="@applicant.Id" />
											<input type="hidden" name="status" value="Rejected" />
											<button type="submit" class="btn reject-btn">REJECT</button>
										</form>
											break;
										<a asp-route-id="@applicant.Id" class="status-btn" asp-controller="HR" asp-action="InviteToHRInterview">INVITE TO HR INTERVIEW</a>
										<a asp-route-id="@applicant.Id" class="reject-btn" asp-controller="HR" asp-action="RejectApplicant">REJECT</a>
										break;
									case ApplicationStatus.ForHRInterview:
										<a asp-route-id="@applicant.Id" class="status-btn" asp-controller="HR" asp-action="InviteToTechnicalInterview">INVITE TO TECHNICAL INTERVIEW</a>
										<a asp-route-id="@applicant.Id" class="reject-btn" asp-controller="HR" asp-action="RejectApplicant">REJECT</a>
										break;
									case ApplicationStatus.ForTechnicalInterview:
										<a asp-route-id="@applicant.Id" class="status-btn" asp-controller="HR" asp-action="InviteToTechnicalExam">INVITE TO TECHNICAL EXAM</a>
										<a asp-route-id="@applicant.Id" class="reject-btn" asp-controller="HR" asp-action="RejectApplicant">REJECT</a>
										break;
									case ApplicationStatus.ForTechnicalExam:
										<form asp-controller="HR" asp-action="UpdateApplicantStatus" method="post">
											<input type="hidden" name="id" value="@applicant.Id" />
											<input type="hidden" name="status" value="UndergoingBackgroundCheck" />
											<button type="submit" class="btn status-btn status-change-btn">CHECK BACKGROUND</button>
										</form>
										<form asp-controller="HR" asp-action="UpdateApplicantStatus" method="post">
											<input type="hidden" name="id" value="@applicant.Id" />
											<input type="hidden" name="status" value="Rejected" />
											<button type="submit" class="btn reject-btn">REJECT</button>
										</form>
											break;
										<a asp-route-id="@applicant.Id" class="status-btn" asp-controller="HR" asp-action="CheckBackground">CHECK BACKGROUND</a>
										<a asp-route-id="@applicant.Id" class="reject-btn" asp-controller="HR" asp-action="RejectApplicant">REJECT</a>
										break;
									case ApplicationStatus.UndergoingBackgroundCheck:
										<form asp-controller="HR" asp-action="UpdateApplicantStatus" method="post">
											<input type="hidden" name="id" value="@applicant.Id" />
											<input type="hidden" name="status" value="ForFinalInterview" />
											<button type="submit" class="btn status-btn status-change-btn">INVITE TO FINAL INTERVIEW</button>
										</form>
										<form asp-controller="HR" asp-action="UpdateApplicantStatus" method="post">
											<input type="hidden" name="id" value="@applicant.Id" />
											<input type="hidden" name="status" value="Rejected" />
											<button type="submit" class="btn reject-btn">REJECT</button>
										</form>
											break;
										<a asp-route-id="@applicant.Id" class="status-btn" asp-controller="HR" asp-action="InviteToFinalInterview">INVITE TO FINAL INTERVIEW</a>
										<a asp-route-id="@applicant.Id" class="reject-btn" asp-controller="HR" asp-action="RejectApplicant">REJECT</a>
										break;
									case ApplicationStatus.ForFinalInterview:
										<form asp-controller="HR" asp-action="UpdateApplicantStatus" method="post">
											<input type="hidden" name="id" value="@applicant.Id" />
											<input type="hidden" name="status" value="UndergoingJobOffer" />
											<button type="submit" class="btn status-btn status-change-btn">SEND JOB OFFER</button>
											</form>
										<form asp-controller="HR" asp-action="UpdateApplicantStatus" method="post">
											<input type="hidden" name="id" value="@applicant.Id" />
											<input type="hidden" name="status" value="Rejected" />
											<button type="submit" class="btn reject-btn">REJECT</button>
										</form>
											break;
										<a asp-route-id="@applicant.Id" class="status-btn" asp-controller="HR" asp-action="SendJobOffer">SEND JOB OFFER</a>
										<a asp-route-id="@applicant.Id" class="reject-btn" asp-controller="HR" asp-action="RejectApplicant">REJECT</a>
										break;
									case ApplicationStatus.UndergoingJobOffer:
										<form asp-controller="HR" asp-action="UpdateApplicantStatus" method="post">
											<input type="hidden" name="id" value="@applicant.Id" />
											<input type="hidden" name="status" value="Confirmed" />
											<button type="submit" class="btn status-btn status-change-btn">CONFIRM</button>
										</form>
										<form asp-controller="HR" asp-action="UpdateApplicantStatus" method="post">
											<input type="hidden" name="id" value="@applicant.Id" />
											<input type="hidden" name="status" value="NotConfirmed" />
											<button type="submit" class="btn reject-btn">DECLINE</button>
										</form>
											break;
										case ApplicationStatus.Confirmed:
										<form asp-controller="HR" asp-action="UpdateApplicantStatus" method="post">
											<input type="hidden" name="id" value="@applicant.Id" />
											<input type="hidden" name="status" value="Onboarding" />
											<button type="submit" class="btn status-btn status-change-btn">ONBOARD</button>
										</form>
										<form asp-controller="HR" asp-action="UpdateApplicantStatus" method="post">
											<input type="hidden" name="id" value="@applicant.Id" />
											<input type="hidden" name="status" value="NotConfirmed" />
											<button type="submit" class="btn reject-btn">DECLINE</button>
										</form>
											break;
										<a asp-route-id="@applicant.Id" class="status-btn" asp-controller="HR" asp-action="ConfirmApplicant">CONFIRM</a>
										<a asp-route-id="@applicant.Id" class="decline-btn" asp-controller="HR" asp-action="DeclineApplicant">DECLINE</a>
										break;
									case ApplicationStatus.Onboarding:
										<form asp-controller="HR" asp-action="UpdateApplicantStatus" method="post">
											<input type="hidden" name="id" value="@applicant.Id" />
											<input type="hidden" name="status" value="Deployed" />
											<button type="submit" class="btn status-btn status-change-btn" style="justify-content: flex-start !important;">DEPLOY</button>
											</form>
											break;
										default:
										<a asp-route-id="@applicant.Id" class="status-btn" asp-controller="HR" asp-action="DeployApplicant" style="justify-content: flex-start !important;">DEPLOY </a>
										break;
									default:
										break;
								}
							</div>
						</td>
					</tr>
					</a>
				}
			</tbody>
		</table>
	</div>
	<div class="pagination-container">
		<ul class="pagination">
			<!-- Pagination links will be added dynamically via JavaScript -->
		</ul>
	</div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>


<script>
	$(document).ready(function () {
		const rowsPerPage = 10; // Number of rows to display per page
		let currentPage = 1;

		// Click event to each row
		$('.clickable-row').on('click', function () {
			const href = $(this).data('href');
			if (href) {
				window.location = href;
			}
		});

		// Function to display the table rows for the selected page and filter options
		function showPage(pageNumber, positionFilter, statusFilter) {
			const rows = $('.table tbody tr');
			const filteredRows = filterRows(positionFilter, statusFilter);

			rows.hide();
			for (let i = (pageNumber - 1) * rowsPerPage; i < pageNumber * rowsPerPage && i < filteredRows.length; i++) {
				$(filteredRows[i]).show();
			}

			currentPage = pageNumber;
			$('.pagination li a').removeClass('active');
			$('.pagination li a[data-page="' + pageNumber + '"]').addClass('active');

			$('.pagination .prev-btn').prop('disabled', pageNumber === 1);
			$('.pagination .next-btn').prop('disabled', pageNumber === totalPages());

			$('.pagination .prev-btn').toggleClass('disabled', pageNumber === 1);
			$('.pagination .next-btn').toggleClass('disabled', pageNumber === totalPages());
		}

		// Helper function to get the description of an enum value
		function getEnumDescriptionForStatus(statusText) {
			const enumDescriptions = {
				"Application Received!": "Received",
				"Shortlisted": "Shortlisted",
				"For Screening": "ForScreening",
				"For HR Interview": "ForHRInterview",
				"For Technical Interview": "ForTechnicalInterview",
				"For Technical Exam": "ForTechnicalExam",
				"Undergoing Background Check": "UndergoingBackgroundCheck",
				"For Final Interview": "ForFinalInterview",
				"Undergoing Job Offer": "UndergoingJobOffer",
				"Confirmed": "Confirmed",
				"Not Confirmed": "NotConfirmed",
				"Onboarding": "Onboarding",
				"Deployed": "Deployed",
				"Rejected": "Rejected",
			};

			return enumDescriptions[statusText] || statusText;
		}

		// Function to filter rows based on the selected position and status
		function filterRows(positionFilter, statusFilter) {
			let rows = $('.table tbody tr');

			if (positionFilter !== 'ALL') {
				rows = rows.filter(function () {
					const positionName = $(this).find('td:nth-child(2)').text().toLowerCase();
					return positionName.includes(positionFilter.toLowerCase());
				});
			}

			if (statusFilter !== 'ALL') {
				rows = rows.filter(function () {
					const statusName = $(this).find('td:nth-child(3)').text().trim();
					const statusValue = getEnumDescriptionForStatus(statusName); 
					return statusValue === statusFilter.trim();
				});
			}

			return rows;
		}

		// Function to calculate the total number of pages based on the number of rows
		function totalPages() {
			const totalRows = filterRows($('#position').val(), $('#status').val()).length;
			return Math.ceil(totalRows / rowsPerPage);
		}

		$('.pagination').on('click', '.prev-btn', function () {
			if (currentPage > 1) {
				showPage(currentPage - 1, $('#position').val(), $('#status').val());
			}
		});

		$('.pagination').on('click', '.next-btn', function () {
			if (currentPage < totalPages()) {
				showPage(currentPage + 1, $('#position').val(), $('#status').val());
			}
		});

		$('.pagination').on('click', 'li a[data-page]', function () {
			const page = parseInt($(this).data('page'));
			showPage(page, $('#position').val(), $('#status').val());
		});

		$('#position, #status').change(function () {
			generatePaginationLinks();
			showPage(1, $('#position').val(), $('#status').val());
		});

		// Function to generate pagination links
		function generatePaginationLinks() {
			const paginationContainer = $('.pagination');
			paginationContainer.empty();

			paginationContainer.append('<li><a href="#" class="prev-btn">Previous</a></li>');
			for (let i = 1; i <= totalPages(); i++) {
				paginationContainer.append(`<li><a href="#" data-page="${i}">${i}</a></li>`);
			}

			paginationContainer.append('<li><a href="#" class="next-btn">Next</a></li>');
			$('.pagination li a[data-page="' + currentPage + '"]').addClass('active');
			$('.pagination .prev-btn').prop('disabled', true);
		}

		generatePaginationLinks();
		showPage(1, $('#position').val(), $('#status').val());
	});
</script>